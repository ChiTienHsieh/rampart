# Rampart Docker Compose
#
# Usage:
#   CLAUDE_CODE_OAUTH_TOKEN=xxx docker compose run base claude -p "prompt" --dangerously-skip-permissions
#   ANTHROPIC_API_KEY=xxx docker compose --profile uv run uv claude -p "prompt" --dangerously-skip-permissions

services:
  base:
    build:
      context: ../images
      dockerfile: base.Dockerfile
    image: rampart-base
    volumes:
      # Workspace - main content writable
      - ${WORKSPACE:-.}:/workspace
      # Container-only volumes for platform-specific binaries
      # Prevents Linux node_modules from polluting macOS host (and vice versa)
      - node_modules:/workspace/node_modules
      - venv:/workspace/.venv
    environment:
      # OAuth token passed from host - only exists in container memory at runtime
      # Security note: Token can be revoked at claude.ai/settings if compromised
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    # OrbStack: host.docker.internal works out of the box
    extra_hosts:
      - "host.docker.internal:host-gateway"
    working_dir: /workspace
    stdin_open: true
    tty: true

  uv:
    build:
      context: ../images
      dockerfile: uv.Dockerfile
    image: rampart-uv
    extends:
      service: base
    profiles:
      - uv

  # Future profiles can be added here:
  # npm:
  #   profiles: ["npm"]
  # playwright:
  #   profiles: ["playwright"]

volumes:
  node_modules:
  venv:
